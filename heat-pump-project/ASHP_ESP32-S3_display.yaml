esphome:
  name: ashp-display
  friendly_name: "ASHP Display"
  min_version: 2025.05.2
  platformio_options:
    build_unflags: -Werror=all
    board_build.flash_mode: dio
    build_flags:
      - -DBOARD_HAS_PSRAM
    board_build.esp-idf.memory_type: qio_opi
    board_upload.maximum_ram_size: 524288
    board_build.flash_size: 8MB

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  flash_size: 8MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESPTOOLPY_FLASHSIZE_8MB: "y"
      CONFIG_FREERTOS_HZ: "1000"
      CONFIG_ESP_DEFAULT_CPU_FREQ_MHZ_240: y
      CONFIG_ESPTOOLPY_FLASHMODE_QIO: y
      CONFIG_ESPTOOLPY_FLASHFREQ_80M: y
      CONFIG_SPIRAM_MODE_OCT: y
      CONFIG_IDF_EXPERIMENTAL_FEATURES: y
      CONFIG_SPIRAM_SPEED_80M: y
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: y
    advanced:
      enable_idf_experimental_features: False

# host:
#   mac_address: "de:ad:be:ef:fe:ed"

logger:
  level: DEBUG
  hardware_uart: UART0
  baud_rate: 0
  logs:
    safe_mode: INFO
    debug: INFO
    main: INFO
    esp-idf: WARN
    esp32.preferences: INFO
    wifi: WARN
    api: WARN
    sntp: WARN
    i2c: WARN
    i2c.idf: WARN
    ch422g: WARN
    touchscreen: WARN
    gt911.touchscreen: WARN
    switch: WARN
    sensor: WARN
    binary_sensor: WARN
    text_sensor: WARN
    light: WARN
    select: WARN
    homeassistant.sensor: WARN
    homeassistant.binary_sensor: WARN
    homeassistant.text_sensor: WARN
    template.switch: WARN
    script: WARN
    http_request: WARN
    http_request.idf: WARN
    online_image: WARN
    number: WARN

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

http_request:
  verify_ssl: false

debug:

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

psram:
  mode: octal
  speed: 80MHz

ch422g:
  - id: io_ex

i2c:
  sda: 8
  scl: 9
  frequency: 400kHz
  scan: false
  id: bus_a

safe_mode:

button:
  - platform: safe_mode
    name: "Device Restart (Safe mode)"
    id: id_button_device_restart_safe_mode
    icon: mdi:restart-alert

# Touchscreen (hardware)
touchscreen:
  platform: gt911
  address: 0x5D
  id: my_touchscreen
  interrupt_pin: 4
  reset_pin:
    ch422g: io_ex
    number: 1

# Display (hardware)
display:
  - platform: rpi_dpi_rgb
    id: device_display
    update_interval: never
    auto_clear_enabled: false
    color_order: RGB
    pclk_frequency: 21MHz
    dimensions:
      width: 800
      height: 480
    reset_pin:
      ch422g: io_ex
      number: 2
    de_pin:
      number: 5
    hsync_pin:
      number: 46
      ignore_strapping_warning: true
    vsync_pin:
      number: 3
      ignore_strapping_warning: true
    pclk_pin: 7
    pclk_inverted: true
    hsync_back_porch: 16
    hsync_front_porch: 210
    hsync_pulse_width: 4
    vsync_back_porch: 13
    vsync_front_porch: 4
    vsync_pulse_width: 4
    data_pins:
      red: [1, 2, 42, 41, 40]
      blue: [14, 38, 18, 17, 10]
      green: [39, 0, 45, 48, 47, 21]

# UART/Modbus (hardware—keep wiring as per your device)
uart:
  id: mod_bus
  tx_pin: GPIO15
  rx_pin: GPIO16
  baud_rate: 19200
  stop_bits: 1
  parity: NONE
  data_bits: 8

modbus:
  id: modbus1
  uart_id: mod_bus

# Bring in your Modbus controller and register maps (adjust paths)
modbus_controller: !include includes/modbus_controller.yaml
binary_sensor: !include includes/modbus_binary_sensors.yaml
switch: !include includes/modbus_switches.yaml
number: !include includes/modbus_numbers.yaml
sensor: !include includes/modbus_sensors.yaml

# Fonts and assets
font:
  - file: 'fonts/FA7-Free-Solid-900.otf'
    id: fa_20
    size: 20
    bpp: 4
    glyphs: ["\uF053", "\uF054", "\uF015", "\uF1EB"]

  - file: "fonts/excelate.ttf"
    id: excelate_24
    size: 24
    bpp: 4

  - file: "fonts/excelate.ttf"
    id: excelate_18
    size: 18
    bpp: 4

image:
  - file: "images/aerona3.png"
    id: aerona_heat_pump_img
    type: RGB565
    resize: 340x440
    # Omit transparency to avoid edge artifacts on hardware
    transparency: alpha_channel

# LVGL UI (three pages + top-layer)
lvgl:
  displays: [device_display]
  touchscreens: [my_touchscreen]
  buffer_size: 25%
  log_level: INFO
  color_depth: 16
  byte_order: big_endian

  theme:
    label:
      text_color: 0xFFFFFF
    button:
      bg_color: 0x2F8CD8
      bg_grad_color: 0x005782
      bg_grad_dir: VER
      bg_opa: COVER
      border_color: 0x0077b3
      border_width: 1
      text_color: 0xFFFFFF
      pressed:
        bg_color: 0x006699
        bg_grad_color: 0x00334d
    buttonmatrix:
      bg_opa: TRANSP
      border_width: 0
      text_color: 0xFFFFFF
      items:
        bg_color: 0x2F8CD8
        bg_grad_color: 0x005782
        bg_grad_dir: VER
        bg_opa: COVER
        border_color: 0x0077b3
        border_width: 1
        text_color: 0xFFFFFF
    switch:
      bg_color: 0xC0C0C0
      bg_grad_color: 0xB0B0B0
      bg_grad_dir: VER
      bg_opa: COVER
      checked:
        bg_color: 0x1D5F96
        bg_grad_color: 0x03324A
        bg_grad_dir: VER
        bg_opa: COVER
      knob:
        bg_color: 0xFFFFFF
        bg_grad_color: 0xC0C0C0
        bg_grad_dir: VER
        bg_opa: COVER

  style_definitions:
    - id: header_footer
      bg_color: 0x2F8CD8
      bg_grad_color: 0x005782
      bg_grad_dir: VER
      bg_opa: COVER
      border_opa: TRANSP
      radius: 0
      pad_all: 0
      pad_row: 0
      pad_column: 0
      border_color: 0x0077b3
      text_color: 0xFFFFFF
      width: 100%
      height: 30

  top_layer:
    widgets:
      - buttonmatrix:
          align: bottom_mid
          styles: header_footer
          pad_all: 0
          outline_width: 0
          id: nav_bar
          items:
            styles: header_footer
          rows:
            - buttons:
              - id: page_prev
                text: "\uF053"
                on_press:
                  then:
                    lvgl.page.previous:
              - id: page_home
                text: "\uF015"
                on_press:
                  then:
                    lvgl.page.show: home_page
              - id: page_next
                text: "\uF054"
                on_press:
                  then:
                    lvgl.page.next:
      - label:
          text: "\uF1EB"
          id: lbl_hastatus
          hidden: true
          align: top_right
          x: -6
          y: 6
          text_align: right
          text_font: fa_20
          text_color: 0xFFFFFF

  pages:
    - id: home_page
      widgets:
        - obj:
            width: 800
            height: 480
            bg_color: 0x464B55
            border_width: 0
            pad_all: 8
            widgets:
              - obj:
                  align: TOP_MID
                  styles: header_footer
                  widgets:
                    - label:
                        text: "Grant Aerona3"
                        align: CENTER
                        text_align: CENTER
                        text_color: 0xFFFFFF
              - image:
                  id: aerona_image
                  src: aerona_heat_pump_img
                  align: LEFT_MID
                  x: 12
                  y: 10
                  width: 340
                  height: 440
                  border_width: 0
              - obj:
                  align: RIGHT_MID
                  x: -10
                  y: 0
                  width: SIZE_CONTENT
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  border_opa: TRANSP
                  pad_all: 8
                  widgets:
                    - label:
                        id: heatalizer_label
                        text: "Heatalizer"
                        align: TOP_LEFT
                        x: 20
                        y: 0
                        text_font: excelate_24
                        text_color: 0xFFFFFF
                    - label:
                        id: heatalizer_3000_label
                        text: "3000"
                        align_to:
                          id: heatalizer_label
                          align: OUT_RIGHT_MID
                          x: -18
                          y: 20
                        text_font: excelate_18
                        text_color: 0xFFC107

    - id: current_operation_page
      widgets:
        - obj:
            width: 800
            height: 480
            bg_color: 0x464B55
            border_width: 0
            pad_all: 10
            widgets:
              - obj:
                  align: TOP_MID
                  styles: header_footer
                  widgets:
                    - label:
                        text: "Current Operation"
                        align: CENTER
                        text_align: CENTER
                        text_color: 0xFFFFFF

              - obj:
                  id: op_left_container
                  align: LEFT_MID
                  x: 10
                  y: 0
                  width: 280
                  height: 400
                  bg_color: 0x535966
                  border_width: 0
                  pad_all: 10
                  widgets:
                    - label:
                        text: "Power"
                        align: TOP_MID
                        y: 0
                        text_font: montserrat_16
                        text_color: 0xFFFFFF
                    - obj:
                        id: power_gauge_box
                        align: TOP_MID
                        y: 22
                        width: 240
                        height: 160
                        bg_color: 0x2B2F36
                        border_width: 0
                        pad_all: 6
                        widgets:
                          - meter:
                              id: power_meter
                              height: 100%
                              width: 100%
                              border_width: 0
                              bg_opa: TRANSP
                              align: CENTER
                              scales:
                                - range_from: 0
                                  range_to: 60
                                  angle_range: 180
                                  rotation: 180
                                  ticks:
                                    count: 0
                                  indicators:
                                    - arc:
                                        color: 0x2468B3
                                        r_mod: 12
                                        width: 22
                                        start_value: 0
                                        end_value: 30
                                    - arc:
                                        color: 0xE0621A
                                        r_mod: 12
                                        width: 22
                                        start_value: 30
                                        end_value: 60
                                - range_from: 0
                                  range_to: 60
                                  angle_range: 180
                                  rotation: 180
                                  ticks:
                                    count: 0
                                  indicators:
                                    - line:
                                        id: power_needle
                                        width: 5
                                        color: 0xFFC107
                                        r_mod: 8
                                        value: 0
                          # - obj:
                          #     height: 14
                          #     width: 14
                          #     radius: 7
                          #     align: CENTER
                          #     border_width: 0
                          #     pad_all: 0
                          #     bg_color: 0xFFC107
                          - label:
                              id: power_text
                              text_font: montserrat_20
                              align: CENTER
                              y: 56
                              text: "--.- kW"
                              text_color: 0xFFD54F

                    - label:
                        text: "Compressor Frequency"
                        align: TOP_MID
                        y: 196
                        text_font: montserrat_16
                        text_color: 0xFFFFFF
                    - obj:
                        id: freq_gauge_box
                        align: TOP_MID
                        y: 218
                        width: 240
                        height: 160
                        bg_color: 0x2B2F36
                        border_width: 0
                        pad_all: 6
                        widgets:
                          - meter:
                              id: freq_meter
                              height: 100%
                              width: 100%
                              border_width: 0
                              bg_opa: TRANSP
                              align: CENTER
                              scales:
                                - range_from: 0
                                  range_to: 90
                                  angle_range: 180
                                  rotation: 180
                                  ticks:
                                    count: 0
                                  indicators:
                                    - arc:
                                        color: 0x2468B3
                                        r_mod: 12
                                        width: 22
                                        start_value: 0
                                        end_value: 45
                                    - arc:
                                        color: 0xE0621A
                                        r_mod: 12
                                        width: 22
                                        start_value: 45
                                        end_value: 90
                                - range_from: 0
                                  range_to: 90
                                  angle_range: 180
                                  rotation: 180
                                  ticks:
                                    count: 0
                                  indicators:
                                    - line:
                                        id: freq_needle
                                        width: 5
                                        color: 0xFFC107
                                        r_mod: 8
                                        value: 0
                          # - obj:
                          #     height: 14
                          #     width: 14
                          #     radius: 7
                          #     align: CENTER
                          #     border_width: 0
                          #     pad_all: 0
                          #     bg_color: 0xFFC107
                          - label:
                              id: freq_text
                              text_font: montserrat_20
                              align: CENTER
                              y: 56
                              text: "-- Hz"
                              text_color: 0xFFD54F

              - obj:
                  id: temp_container
                  align: RIGHT_MID
                  x: 0
                  y: 0
                  width: 200
                  height: 300
                  bg_color: 0x535966
                  border_width: 0
                  pad_all: 15
                  widgets:
                    - label:
                        text: "Flow Temp"
                        align: TOP_LEFT
                        y: 10
                        text_font: montserrat_16
                        text_color: 0xFFFFFF
                    - label:
                        id: flow_temp_value
                        text: "--°C"
                        align: TOP_LEFT
                        y: 35
                        text_font: montserrat_24
                        text_color: 0x33A1FF
                    - label:
                        text: "Outdoor Temp"
                        align: TOP_LEFT
                        y: 90
                        text_font: montserrat_16
                        text_color: 0xFFFFFF
                    - label:
                        id: outdoor_temp_value
                        text: "--°C"
                        align: TOP_LEFT
                        y: 115
                        text_font: montserrat_24
                        text_color: 0xFF9933
                    - label:
                        text: "Max Flow Temp"
                        align: TOP_LEFT
                        y: 170
                        text_font: montserrat_16
                        text_color: 0xFFFFFF
                    - label:
                        id: set_max_flow_temp_value
                        text: "--°C"
                        align: TOP_LEFT
                        y: 195
                        text_font: montserrat_24
                        text_color: 0x33A1FF

    - id: control_page
      widgets:
        - obj:
            width: 800
            height: 480
            bg_color: 0x464B55
            border_width: 0
            pad_all: 10
            widgets:
              - obj:
                  align: TOP_MID
                  styles: header_footer
                  widgets:
                    - label:
                        text: "Control Page"
                        align: CENTER
                        text_align: CENTER
                        text_color: 0xFFFFFF

              - obj:
                  id: max_dial_container
                  align: LEFT_MID
                  x: 40
                  y: 0
                  width: 300
                  height: 300
                  bg_color: 0x2B2F36
                  border_width: 0
                  pad_all: 15
                  widgets:
                    - label:
                        text: "Set Max Flow Temp"
                        align: TOP_MID
                        y: 10
                        text_font: montserrat_16
                        text_color: 0xFFFFFF
                    - arc:
                        id: max_temp_dial
                        align: CENTER
                        y: 12
                        width: 200
                        height: 200
                        min_value: 20
                        max_value: 65
                        value: 45
                        rotation: 0
                        start_angle: 135
                        end_angle: 45
                        arc_color: 0x2468B3
                        arc_width: 14
                        adjustable: true
                        on_value:
                          - lvgl.label.update:
                              id: max_temp_dial_label
                              text:
                                format: "%.0f°C"
                                args: [ 'x' ]
                        on_release:
                          - homeassistant.action:
                              action: number.set_value
                              data:
                                entity_id: number.set_max_flow_temp
                                value: !lambda return x;
                    # - obj:
                    #     height: 14
                    #     width: 14
                    #     radius: 7
                    #     align: CENTER
                    #     border_width: 0
                    #     pad_all: 0
                    #     bg_color: 0xFFC107
                    - label:
                        id: max_temp_dial_label
                        align: BOTTOM_MID
                        y: 2
                        text: "45°C"
                        text_font: montserrat_32
                        text_color: 0xFFD54F

              - obj:
                  id: min_dial_container
                  align: RIGHT_MID
                  x: -40
                  y: 0
                  width: 300
                  height: 300
                  bg_color: 0x2B2F36
                  border_width: 0
                  pad_all: 15
                  widgets:
                    - label:
                        text: "Set Min Flow Temp"
                        align: TOP_MID
                        y: 10
                        text_font: montserrat_16
                        text_color: 0xFFFFFF
                    - arc:
                        id: min_temp_dial
                        align: CENTER
                        y: 12
                        width: 200
                        height: 200
                        min_value: 20
                        max_value: 65
                        value: 45
                        rotation: 0
                        start_angle: 135
                        end_angle: 45
                        arc_color: 0x2468B3
                        arc_width: 14
                        adjustable: true
                        on_value:
                          - lvgl.label.update:
                              id: min_temp_dial_label
                              text:
                                format: "%.0f°C"
                                args: [ 'x' ]
                        on_release:
                          - homeassistant.action:
                              action: number.set_value
                              data:
                                entity_id: number.set_min_flow_temp
                                value: !lambda return x;
                    # - obj:
                    #     height: 14
                    #     width: 14
                    #     radius: 7
                    #     align: CENTER
                    #     border_width: 0
                    #     pad_all: 0
                    #     bg_color: 0xFFC107
                    - label:
                        id: min_temp_dial_label
                        align: BOTTOM_MID
                        y: 2
                        text: "45°C"
                        text_font: montserrat_32
                        text_color: 0xFFD54F

              
              - switch:
                  id: lv_sw_weather_comp
                  align: BOTTOM_MID
                  y: -60
                  width: 96
                  height: 44
                  bg_color: 0x1F5AA6
                  indicator:
                    bg_color: 0x1F5AA6
                  knob:
                    bg_color: 0xFFFFFF
                  checked:
                    bg_color: 0x2E7D32
                  on_click:
                    - if:
                        condition:
                          lambda: 'return id(weather_comp).state;'
                        then:
                          - switch.turn_off: weather_comp
                        else:
                          - switch.turn_on: weather_comp
              - label:
                  text: "Weather Compensation"
                  align: BOTTOM_MID
                  y: -20
                  text_font: montserrat_16
                  text_color: 0xFFFFFF
